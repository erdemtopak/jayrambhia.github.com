<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head >
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Multithreading in pygtk/gtk+ &mdash; Aniket Pant</title>
        <meta name="author" content="">
        <meta name="description" content="">
        <meta name="keywords" content="jay, rambhia, computer vision, python, trakcing, keypoints, c, c++, simplecv, opencv">
        <meta name="viewport" content="width=device-width">

        
        

        <!-- stylesheets -->
        <link rel="stylesheet" href="/assets/styles/css/style.min.css">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->

        <div class="header-container gw">
            <div class="g one-whole zen-space full-width"></div>
            <div class="wrapper">
                <header class="g one-whole flexbox" role="banner">
                    <h1 class="g one-third portable-one-whole flexbox__item"><a class="logo media" href="/" rel="nofollow"><img class="media__item" src="/assets/images/logo.jpg" alt="Rawrrr! Aniket here." /></a></h1>
                    <nav class="g two-thirds portable-one-whole flexbox__item navbar">
                        <ul class="nav nav--block portable-nav--stacked">
                            <li><a href="/">Home</a></li>
                            <li><a href="/about-me">About Me</a></li>
                            <li><a href="/Blog">Blog</a></li>
                            <li><a href="/archive">Archive</a></li>
                        </ul>
                    </nav>
                    <div class="g two-thirds portable-one-whole flexbox__item">
                        <p class="islet about-me">I'm <strong>Aniket</strong>. I love to code, listen to music and I even write free-verses at times. A majority of my work is <em>writing syntax for design</em>.</p>
                    </div>
                    <p rel="google-authorship" class="accessibility">By Aniket Pant</p>
                </header> <!-- header -->
            </div>
        </div> <!-- header-container -->

        <div class="main-container gw">
            <div class="wrapper">
                <section class="g one-whole" role="main">
                <div class="post multithreading-in-pygtkgtk">
	<header class="g one-quarter portable-one-whole post--header">
  		<h1 class="post_title">Multithreading in pygtk/gtk+</h1>
  		<div class="meta"><date class="date">Posted on 15 February 2012</date><br/>Under <span class="category">Blog</a><br/>Tagged </span><span class="tags">Python</span></div>
      <div class="share island">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="jayrambhia" data-related="jayrambhia">Tweet</a>
        <div class="g-plusone" data-size="medium"></div>
        <div class="fb-like" data-send="false" data-layout="button_count" data-width="450" data-show-faces="true"></div>
      </div>
      <div id="boastful"></div>
	</header><!-- post-header -->
	<div class="g three-quarters portable-one-whole">
		<article class="post--content">
	  	<p>I started making an application/desktop widget for twitter! I made this thing which I call “<strong>tweetBox</strong>”! It’s just this widget/application written in python using pygtk/gtk+ for GUI, using which you can tweet! Only tweet!
It was easy. No messed up code. child’s play.
Then I wanted an application which would also get the timeline. Okay so, I made it. Again! No big deal!
So, now the problem started. I did not want to add a button to get timeline. So I made an EventBox, and whenever mouse pointer moves out of the eventbox, it would fetch the timeline. Since BITS net is notorious for its slow connectivity and to add up to that, sometimes, twitter just stops responding to BITS public IP! Due to almost zero connectivity, I don’t receive any data from twitter and my program is just stuck there. GUI hangs/crashes! And meanwhile, I don’t know how many times mouse pointer must have came back and went out of the eventbox and it makes a loop to fetch data which I am never going to get!
To avoid this, I thought to use multiprocessing since as usual I thought gtk and multithreading don’t go together!
Well, so after hours of hard work(yeah! coding is hard work and if your code just doesn’t work then it’s totally hard work!), I asked couple of question on Quora and stackoverflow and the answer just turned me upside down!
<strong><a href="http://stackoverflow.com/questions/9273476/how-to-modify-a-textview-from-a-different-process">stackoverflow - How to modify a textview from a different process ?</a></strong>
Yeah, So, I found out that <del>gtk and multithreading don’t go together!</del>
gtk and multithreading is the correct way.
So, After reading couple of blogs about gtk and multithreading, I made this GUI for application which I call “<strong>twitterBox</strong>” is working fine. Had some problems in the beginning, but now I’m quite comfortable with it.
<strong><a href="http://blogs.operationaldynamics.com/andrew/software/gnome-desktop/gtk-thread-awareness">Misconceptions about Multithreading and gtk</a></strong></p>
<cont>

<!-- more -->
From this blog, I found out that **all GTK calls must be made from main thread or to put it more appropriately all GTK calls must be made from the main Lock.**
And I was trying to make a different process and make GTK calls. Yeah! I'm insane. I know.
I learned a great deal of multithreading with pygtk/gtk+ from this blog
**[Toward a Secret Sky](http://unpythonic.blogspot.in/2007/08/using-threads-in-pygtk.html)**
It's nicely written and also explained in simple language!

I had to write all the tweets in the tweetview which is a gtk.TextView object using set_text(str) but since I was not in the main lock/thread, I could not do it. I could get text from the TextView using get_text(), but couldn't write.
After reading all these things, I finally made something which could do this. I used **gobject.idle_add()**.

    
    import pygtk
    pygtk.require('2.0')
    import gtk
    from threading import Thread
    import gobject
    gtk.gdk.threads_init()




Let's assume there is gtk.Window object and couple of gtk.HBox and gtk.VBox objects in it. And there is a gtk.TextView object

    
    self.eventbox = gtk.EventBox()
    self.eventbox.set_size_request(700,580)
    self.eventbox.connect('leave_notify_event',self.show_tweet)
    self.vbox.pack_start(self.eventbox, False, False, 2)
    self.eventbox.show()




here, vbox is just a gtk.VBox object (A vertical box) and I'm packing my event box in it.

    
    self.tweetview = gtk.TextView()
    self.tweetbuffer = self.tweetview.get_buffer()
    self.tweetbuffer.set_text('TwitterBoxnby:@jayrambhia')
    self.tweetview.set_editable(False)
    self.tweetview.show()
    self.sw.add(self.tweetview)




wherer sw is gtk.ScrolledWindow object. A scrollbar.

The eventbox in connected to show_tweet.

    
    def show_tweet(self, widget, data=None):
    	self.get_tweet_thread()
    
    def get_tweet_thread(self):
    	Thread(target=self.get_tweet).start()




so, get_tweet_thread() will create a new thread to execute get_tweet()

After getting tweets, to set text in tweetview, we need to use gobject.idle_add(), since The gobject.idle_add() function adds a function (specified by callback) to be called whenever there are no higher priority events pending to the default main loop.

    
    def get_tweet(self):
        ''' code to fetch timeline goes here
        After getting text, set text in tweetview
        '''
        gobject.idle_add(self.set_tweetview, tweet_str)




Now, gobject.idle_add() will add set_tweetview() function in the main loop and widget properties now can be changed.

    
    	def set_tweetview(self,text):
    		self.tweetbuffer.set_text(text)
    		return




Yeah, so, using something like this I made twitterBox. You can check it out on my github repo : [TwitterBox](https://github.com/jayrambhia/TwitterBox)

P.S. Multithreading and OAuth2 elude me!
</cont>
  
		</article><!-- post-content -->
		<footer class="post--footer"></footer><!-- post-footer -->
    <section class="meta--info island">
      <p class="lead">
        <br/><br/>If you liked this post, then you should definitely follow Jay on twitter too. He would be excited to know that you like his work.
      </p>
      <a href="https://twitter.com/jayrambhia" class="twitter-follow-button" data-show-count="false">Follow @jayrambhia</a>
    </section>
  </div>
</div><!-- post -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="/assets/js/jquery.boastful.js"></script>
<script src="/assets/js/rainbow-custom.min.js"></script>

<script type="text/javascript">
  $(document).ready(function() {
    $('#boastful').boastful({
        empty_message: '<p>Bah! Why ain\'t anyone tweeting this.</p>'  
    });
  });
</script>
                </section>
            </div>
        </div> <!-- main-container -->

        <div class="footer-container gw">
            <div class="wrapper">
                <footer class="g one-whole text--center" role="contentinfo">
                    <a href="https://plus.google.com/114828599949215633124?rel=author" class="accessibility">Google +</a>
                    <p><a href="http://twitter.com/aniket_pant">@jayrambhia</a><span class="subtle">&nbsp;|&nbsp;Paranoid Android&nbsp;&nbsp;</span> 
                </footer> <!-- footer -->
            </div>
            <div class="g one-whole zen-space full-width"></div>
        </div> <!-- footer-container -->

        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-23477947-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();

        </script>

        <!-- Typekit Fonts -->
        <script type="text/javascript">
          (function() {
            var config = {
              kitId: 'rsd5dqz',
              scriptTimeout: 3000
            };
            var h=document.getElementsByTagName("html")[0];h.className+=" wf-loading";var t=setTimeout(function(){h.className=h.className.replace(/(\s|^)wf-loading(\s|$)/g," ");h.className+=" wf-inactive"},config.scriptTimeout);var tk=document.createElement("script"),d=false;tk.src='//use.typekit.net/'+config.kitId+'.js';tk.type="text/javascript";tk.async="true";tk.onload=tk.onreadystatechange=function(){var a=this.readyState;if(d||a&&a!="complete"&&a!="loaded")return;d=true;clearTimeout(t);try{Typekit.load(config)}catch(b){}};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(tk,s)
          })();

          (function(doc, script) {
            var js, 
                fjs = doc.getElementsByTagName(script)[0],
                frag = doc.createDocumentFragment(),
                add = function(url, id) {
                    if (doc.getElementById(id)) {return;}
                    js = doc.createElement(script);
                    js.src = url;
                    id && (js.id = id);
                    frag.appendChild( js );
                };
                
              // Google+ button
              add('http://apis.google.com/js/plusone.js');
              // Facebook SDK
              add('//connect.facebook.net/en_US/all.js#xfbml=1&appId=465363156848461', 'facebook-jssdk');
              // Twitter SDK
              add('//platform.twitter.com/widgets.js');

              fjs.parentNode.insertBefore(frag, fjs);
          }(document, 'script'));
        </script>

    </body>
</html>
