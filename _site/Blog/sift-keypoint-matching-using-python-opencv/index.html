<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head >
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>SIFT Keypoint Matching using Python OpenCV &mdash; Aniket Pant</title>
        <meta name="author" content="">
        <meta name="description" content="">
        <meta name="keywords" content="jay, rambhia, computer vision, python, trakcing, keypoints, c, c++, simplecv, opencv">
        <meta name="viewport" content="width=device-width">

        
        

        <!-- stylesheets -->
        <link rel="stylesheet" href="/assets/styles/css/style.min.css">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->

        <div class="header-container gw">
            <div class="g one-whole zen-space full-width"></div>
            <div class="wrapper">
                <header class="g one-whole flexbox" role="banner">
                    <h1 class="g one-third portable-one-whole flexbox__item"><a class="logo media" href="/" rel="nofollow"><img class="media__item" src="/assets/images/logo.jpg" alt="Rawrrr! Aniket here." /></a></h1>
                    <nav class="g two-thirds portable-one-whole flexbox__item navbar">
                        <ul class="nav nav--block portable-nav--stacked">
                            <li><a href="/">Home</a></li>
                            <li><a href="/about-me">About Me</a></li>
                            <li><a href="/Blog">Blog</a></li>
                            <li><a href="/archive">Archive</a></li>
                        </ul>
                    </nav>
                    <div class="g two-thirds portable-one-whole flexbox__item">
                        <p class="islet about-me">I'm <strong>Aniket</strong>. I love to code, listen to music and I even write free-verses at times. A majority of my work is <em>writing syntax for design</em>.</p>
                    </div>
                    <p rel="google-authorship" class="accessibility">By Aniket Pant</p>
                </header> <!-- header -->
            </div>
        </div> <!-- header-container -->

        <div class="main-container gw">
            <div class="wrapper">
                <section class="g one-whole" role="main">
                <div class="post sift-keypoint-matching-using-python-opencv">
	<header class="g one-quarter portable-one-whole post--header">
  		<h1 class="post_title">SIFT Keypoint Matching using Python OpenCV</h1>
  		<div class="meta"><date class="date">Posted on 18 January 2013</date><br/>Under <span class="category">Blog</a><br/>Tagged </span><span class="tags">Computer Vision</span></div>
      <div class="share island">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="jayrambhia" data-related="jayrambhia">Tweet</a>
        <div class="g-plusone" data-size="medium"></div>
        <div class="fb-like" data-send="false" data-layout="button_count" data-width="450" data-show-faces="true"></div>
      </div>
      <div id="boastful"></div>
	</header><!-- post-header -->
	<div class="g three-quarters portable-one-whole">
		<article class="post--content">
	  	<p>I have been working on <a href="http://jayrambhia.wordpress.com/2012/09/24/sift-based-tracker/">SIFT based keypoint tracking</a> algorithm and something happened on Reddit. Kat wanted this is Python so I added this feature in SimpleCV. Here’s the <a href="https://github.com/ingenuitas/SimpleCV/pull/276">pull request</a> which got merged.</p>

<h2 id="sift-keypoints-matching-using-opencv-python"><strong>SIFT KeyPoints Matching using OpenCV-Python</strong>:</h2>

<p>To match keypoints, first we need to find keypoints in the image and template. OpenCV Python version 2.4 only has SURF which can be directly used, for every other detectors and descriptors, new functions are used, i.e. <strong>FeatureDetector_create()</strong> which creates a detector and <strong>DescriptorExtractor_create()</strong> which creates a descriptor to extract keypoints.</p>

<p><strong>Import required modules</strong></p>

<pre><code>import cv2
import numpy as np
import itertools
</code></pre>

<p><strong>Load Images</strong>:</p>

<pre><code>img = cv2.imread("kpimg.png")
template = cv2.imread("kptemplate.png")
</code></pre>

<h4 id="find-keypoints"><strong>Find Keypoints</strong>:</h4>

<pre><code>detector = cv2.FeatureDetector_create("SIFT")
descriptor = cv2.DescriptorExtractor_create("SIFT")

skp = detector.detect(img)
skp, sd = descriptor.compute(img, skp)

tkp = detector.detect(template)
tkp, td = descriptor.compute(template, tkp)
</code></pre>

<p>skp is a list of all the keypoints found on the image. sd is the descriptor for the image.
tkp is a list of all the keypoints found on the template. td is the descriptor for the template.</p>

<p><strong>Properties of cv2.KeyPoint</strong>:</p>

<ul>
  <li>
    <p>pt - coordinates of the keypoint</p>
  </li>
  <li>
    <p>size - diameter of the meaningful keypoint neighborhood</p>
  </li>
  <li>
    <p>angle - computed orientation of the keypoint. range [0,360) degrees.</p>
  </li>
  <li>
    <p>response - the response by which the most strong keypoints have been selected. Can be used for further sorting or subsampling</p>
  </li>
  <li>
    <p>octave - octave (pyramid layer) from which the keypoint has been extracted</p>
  </li>
</ul>

<p><strong>Matching Keypoints using FLANN</strong>:
It was very easy to match keypoints in C++ using FlannMatcher, but it’s a bit difficult to that in Python.</p>

<pre><code>flann_params = dict(algorithm=1, trees=4)
flann = cv2.flann_Index(sd, flann_params)
idx, dist = flann.knnSearch(td, 1, params={})
del flann
</code></pre>

<p>This method does a fast local approximate nearest neighbors (FLANN) calculation between two sets of feature vectors. The result are two numpy arrays the first one is a list of indexes of the matches and the second one is the match distance value. For the match indices or idx, the index values correspond to the values of td, and the value in the array is the index in td.</p>

<p>i.e. j = idx[i] is where td[i] matches sd[j]. 
The second numpy array, at the index i is the match distance between td[i] and sd[j]. Lower distances mean better matches.</p>

<p>Perform the similar exercise on template to match keypoints of template to the image so that any erroneous keypoint match may be eliminated.</p>

<p><strong>Sorting keypoint matches according to the distance</strong>:</p>

<pre><code>dist = dist[:,0]/2500.0
dist = dist.reshape(-1,).tolist()
idx = idx.reshape(-1).tolist()
indices = range(len(dist))
indices.sort(key=lambda i: dist[i])
dist = [dist[i] for i in indices]
idx = [idx[i] for i in indices]
</code></pre>

<p>After sorting the keypoints according to the distance, filter keypoints by setting a cut-off limit of distance.</p>

<pre><code>skp_final = []
for i, dis in itertools.izip(idx, dist):
    if dis &lt; distance:
        skp_final.append(skp[i])
    else:
        break
</code></pre>

<p>Since keypoints are already sorted according to distance, once the cut-off is surpassed, it is redundant to check for other keypoints.</p>

<p>Do this for both template and image keypoints matches.</p>

<p><strong>Draw Keypoints</strong>:
Now, we have matched keypoints. We need to draw them on a new image which consist of the image and the template. First, I thought it would be too difficult to put two images side by side but I underestimated numpy arrays. Things got real easy.</p>

<pre><code>h1, w1 = img.shape[:2]
h2, w2 = template.shape[:2]
nWidth = w1+w2
nHeight = max(h1, h2)
hdif = (h1-h2)/2
newimg = np.zeros((nHeight, nWidth, 3), np.uint8)
newimg[hdif:hdif+h2, :w2] = template
newimg[:h1, w2:w1+w2] = img
</code></pre>

<p>After successfully creating a side by side image of template and the image, draw lines joining matched points.</p>

<pre><code>tkp = tkp_final
skp = skp_fianl
for i in range(min(len(tkp), len(skp)))
    pt_a = (int(tkp[i].pt[0]), int(tkp[i].pt[1]+hdif))
    pt_b = (int(skp[i].pt[0]+w2), int(skp[i].pt[1]))
    cv2.line(newimg, pt_a, pt_b, (255, 0, 0))
</code></pre>

<p>I was working on this code last night. After working on this for 3 hours and making it work, I somehow managed to copy-paste the old file on to the code and well couldn’t get back. Spent another half hour to rewrite the code. Sent a pull request to SimpleCV. It got merged.</p>

<p><strong>SIFT Keypoint matching with SimpleCV</strong>
I put it in the SimpleCV and it’s now really easy to do SIFT matching in SimpleCV.</p>

<pre><code>from SimpleCV import *
i1=Image("kptemp.png")
i=Image("kpimg.png")
i.drawSIFTKeyPointMatch(i1,distance=50).show()
</code></pre>

<p>The full running code is available on <a href="https://github.com/jayrambhia/Vision/blob/master/OpenCV/Python/sift_matching.py">GitHub</a>.</p>

<p>P.S. Going to Bangalore tomorrow to attend Design Innovation Worskhop by MIT Media Labs in collaboration with PESIT.</p>
  
		</article><!-- post-content -->
		<footer class="post--footer"></footer><!-- post-footer -->
    <section class="meta--info island">
      <p class="lead">
        <br/><br/>If you liked this post, then you should definitely follow Jay on twitter too. He would be excited to know that you like his work.
      </p>
      <a href="https://twitter.com/jayrambhia" class="twitter-follow-button" data-show-count="false">Follow @jayrambhia</a>
    </section>
  </div>
</div><!-- post -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="/assets/js/jquery.boastful.js"></script>
<script src="/assets/js/rainbow-custom.min.js"></script>

<script type="text/javascript">
  $(document).ready(function() {
    $('#boastful').boastful({
        empty_message: '<p>Bah! Why ain\'t anyone tweeting this.</p>'  
    });
  });
</script>
                </section>
            </div>
        </div> <!-- main-container -->

        <div class="footer-container gw">
            <div class="wrapper">
                <footer class="g one-whole text--center" role="contentinfo">
                    <a href="https://plus.google.com/114828599949215633124?rel=author" class="accessibility">Google +</a>
                    <p><a href="http://twitter.com/aniket_pant">@jayrambhia</a><span class="subtle">&nbsp;|&nbsp;Paranoid Android&nbsp;&nbsp;</span> 
                </footer> <!-- footer -->
            </div>
            <div class="g one-whole zen-space full-width"></div>
        </div> <!-- footer-container -->

        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-23477947-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();

        </script>

        <!-- Typekit Fonts -->
        <script type="text/javascript">
          (function() {
            var config = {
              kitId: 'rsd5dqz',
              scriptTimeout: 3000
            };
            var h=document.getElementsByTagName("html")[0];h.className+=" wf-loading";var t=setTimeout(function(){h.className=h.className.replace(/(\s|^)wf-loading(\s|$)/g," ");h.className+=" wf-inactive"},config.scriptTimeout);var tk=document.createElement("script"),d=false;tk.src='//use.typekit.net/'+config.kitId+'.js';tk.type="text/javascript";tk.async="true";tk.onload=tk.onreadystatechange=function(){var a=this.readyState;if(d||a&&a!="complete"&&a!="loaded")return;d=true;clearTimeout(t);try{Typekit.load(config)}catch(b){}};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(tk,s)
          })();

          (function(doc, script) {
            var js, 
                fjs = doc.getElementsByTagName(script)[0],
                frag = doc.createDocumentFragment(),
                add = function(url, id) {
                    if (doc.getElementById(id)) {return;}
                    js = doc.createElement(script);
                    js.src = url;
                    id && (js.id = id);
                    frag.appendChild( js );
                };
                
              // Google+ button
              add('http://apis.google.com/js/plusone.js');
              // Facebook SDK
              add('//connect.facebook.net/en_US/all.js#xfbml=1&appId=465363156848461', 'facebook-jssdk');
              // Twitter SDK
              add('//platform.twitter.com/widgets.js');

              fjs.parentNode.insertBefore(frag, fjs);
          }(document, 'script'));
        </script>

    </body>
</html>
